{"ast":null,"code":"import _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from 'react';\nimport { Alert } from '~/components/Alert/Alert';\nimport { Editable } from '~/components/Editable/Editable';\nimport IFrame from '~/components/IFrame/IFrame';\nimport { Toggle } from '~/components/Toggle/Toggle';\nimport { Application } from '~/contexts/Application';\nimport NavigationIcon from '~/icons/Navigation';\nimport PublicIcon from '~/icons/public.svg';\nimport SecretIcon from '~/icons/secret.svg';\nimport { confirm } from '~/utilities/confirm';\nimport { pluck } from '~/utilities/pluck';\nimport { URI } from '~/utilities/URI';\nimport './map.scss';\nvar STATE_FIELDS = ['_id', 'checksum', 'data', 'isOwner', 'isEditable', 'secret', 'slug', 'svg', 'title'];\n\nvar Map = /*#__PURE__*/function (_Component) {\n  _inherits(Map, _Component);\n\n  var _super = _createSuper(Map);\n\n  function Map() {\n    var _this;\n\n    _classCallCheck(this, Map);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _super.call.apply(_super, [this].concat(args));\n\n    _defineProperty(_assertThisInitialized(_this), \"state\", _objectSpread(_objectSpread({}, pluck(_this.props, STATE_FIELDS)), {}, {\n      generating: false\n    }));\n\n    _defineProperty(_assertThisInitialized(_this), \"handleDelete\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var router, slug, map, json;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              router = _this.context.router;\n              slug = _this.props.slug;\n              _context.next = 4;\n              return confirm('Are you sure you want to permanently delete this map?');\n\n            case 4:\n              if (_context.sent) {\n                _context.next = 6;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 6:\n              _context.next = 8;\n              return fetch(\"/api/map/\".concat(slug), {\n                method: 'DELETE'\n              });\n\n            case 8:\n              _context.next = 10;\n              return fetch(\"/api/map/\".concat(slug));\n\n            case 10:\n              map = _context.sent;\n              _context.t0 = _objectSpread;\n              _context.t1 = _objectSpread;\n              _context.t2 = {};\n              _context.t3 = pluck;\n              _context.next = 17;\n              return map.json();\n\n            case 17:\n              _context.t4 = _context.sent;\n              _context.t5 = STATE_FIELDS;\n              _context.t6 = (0, _context.t3)(_context.t4, _context.t5);\n              _context.t7 = (0, _context.t1)(_context.t2, _context.t6);\n              _context.t8 = {};\n              _context.t9 = {\n                _id: null,\n                data: null,\n                title: router.query.title || ''\n              };\n              json = (0, _context.t0)(_context.t7, _context.t8, _context.t9);\n\n              _this.context.updateUser();\n\n              _this.setState(_objectSpread(_objectSpread({}, json), {}, {\n                generating: false\n              }));\n\n            case 26:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"handleGenerate\", function () {\n      return _this.setState({\n        generating: true\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleOnReady\", /*#__PURE__*/function () {\n      var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref2) {\n        var window, _this$state, _id, checksum, data, generating, slug, map;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                window = _ref2.window;\n                _this.iframeWindow = window;\n                _this$state = _this.state, _id = _this$state._id, checksum = _this$state.checksum, data = _this$state.data, generating = _this$state.generating;\n                slug = _this.props.slug;\n\n                if (!data) {\n                  _context2.next = 8;\n                  break;\n                }\n\n                window.displayJsonData(data);\n                _context2.next = 18;\n                break;\n\n              case 8:\n                if (!_id) {\n                  _context2.next = 17;\n                  break;\n                }\n\n                _this.setState({\n                  loading: true\n                });\n\n                _context2.next = 12;\n                return fetch(\"/api/map/\".concat(slug, \"/\").concat(checksum), {\n                  credentials: 'include'\n                }).then(function (response) {\n                  return response.json();\n                })[\"catch\"](function () {\n                  return null;\n                });\n\n              case 12:\n                map = _context2.sent;\n\n                if (map && map.data) {\n                  window.displayJsonData(map.data);\n                }\n\n                _this.setState({\n                  loading: false\n                });\n\n                _context2.next = 18;\n                break;\n\n              case 17:\n                if (generating) {\n                  window.regenerateMap(function () {\n                    return _this.setState({\n                      data: window.packageJsonData()\n                    });\n                  });\n                }\n\n              case 18:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      return function (_x) {\n        return _ref3.apply(this, arguments);\n      };\n    }());\n\n    _defineProperty(_assertThisInitialized(_this), \"handleSave\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var data, saved;\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _this.setState({\n                saving: true\n              });\n\n              data = _this.iframeWindow.packageJsonData();\n              _context3.next = 4;\n              return fetch(\"/api/map/\".concat(_this.props.slug), {\n                body: JSON.stringify(_objectSpread(_objectSpread({}, pluck(_this.state, STATE_FIELDS)), {}, {\n                  data: data\n                })),\n                headers: {\n                  'Content-Type': 'application/json'\n                },\n                method: 'POST'\n              }).then(function (r) {\n                return r.json();\n              });\n\n            case 4:\n              saved = _context3.sent;\n\n              _this.setState(_objectSpread(_objectSpread({}, saved), {}, {\n                saving: false\n              }));\n\n            case 6:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"handleTitleChange\", function (title) {\n      return _this.setState({\n        title: title\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleToggleNavigation\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      var _this$props, slug, title, campaign, navigation;\n\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              _this$props = _this.props, slug = _this$props.slug, title = _this$props.title;\n              campaign = _this.context.campaign;\n\n              if (campaign) {\n                _context4.next = 4;\n                break;\n              }\n\n              return _context4.abrupt(\"return\");\n\n            case 4:\n              navigation = campaign.navigation || [];\n\n              if (_this.isNavLink) {\n                navigation = navigation.filter(function (n) {\n                  return n.slug !== slug;\n                });\n              } else {\n                navigation.push({\n                  slug: slug,\n                  title: title\n                });\n              }\n\n              _this.context.updateCampaign({\n                navigation: navigation\n              });\n\n            case 7:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"handleToggleSecret\", /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _this.handleUpdate({\n                secret: !_this.state.secret\n              });\n\n            case 1:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"handleUpdate\", /*#__PURE__*/function () {\n      var _ref7 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(payload) {\n        var keys, response, updated;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                keys = Object.keys(payload);\n                _context6.next = 3;\n                return fetch(\"/api/map/\".concat(_this.props.slug), {\n                  body: JSON.stringify(payload),\n                  headers: {\n                    'Content-Type': 'application/json'\n                  },\n                  method: 'POST'\n                });\n\n              case 3:\n                response = _context6.sent;\n                _context6.t0 = pluck;\n                _context6.t1 = void 0;\n                _context6.next = 8;\n                return response.json();\n\n              case 8:\n                _context6.t2 = _context6.sent;\n                _context6.t3 = [_context6.t2].concat(_toConsumableArray(keys));\n                updated = _context6.t0.apply.call(_context6.t0, _context6.t1, _context6.t3);\n\n                if (response.status === 200) {\n                  _this.setState(updated);\n                }\n\n              case 12:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6);\n      }));\n\n      return function (_x2) {\n        return _ref7.apply(this, arguments);\n      };\n    }());\n\n    _defineProperty(_assertThisInitialized(_this), \"render\", function () {\n      var campaign = _this.context.campaign;\n      var slug = _this.props.slug;\n      var _this$state2 = _this.state,\n          _id = _this$state2._id,\n          data = _this$state2.data,\n          loading = _this$state2.loading,\n          generating = _this$state2.generating,\n          isEditable = _this$state2.isEditable,\n          isOwner = _this$state2.isOwner,\n          saving = _this$state2.saving,\n          secret = _this$state2.secret,\n          title = _this$state2.title;\n      var contents;\n\n      if (_id || isEditable && generating) {\n        contents = /*#__PURE__*/_jsx(IFrame, {\n          bodyClasses: [isEditable ? 'editable' : 'readOnly'],\n          className: \"map-frame\",\n          css: \"\\n\\t\\t\\t\\t\\t\\t.readOnly #viewbox, .readOnly #scaleBar {\\n\\t\\t\\t\\t\\t\\t\\tpointer-events: none;\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t.readOnly #optionsTab, .readOnly #toolsTab, .readOnly #regenerate {\\n\\t\\t\\t\\t\\t\\t\\tdisplay: none!important;\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t#loading, #initial { display: none; }\\n\\t\\t\\t\\t\\t\",\n          onReady: _this.handleOnReady,\n          src: \"/static/fantasy-map-generator\",\n          queryString: {\n            doNotGenerate: true\n          },\n          title: \"map\"\n        });\n      } else if (isEditable) {\n        contents = /*#__PURE__*/_jsx(Alert, {\n          className: \"center\",\n          children: isEditable && /*#__PURE__*/_jsxs(_Fragment, {\n            children: [\"This map doesn't exist. Would you like to \", /*#__PURE__*/_jsx(\"button\", {\n              className: \"safe\",\n              onClick: _this.handleGenerate,\n              children: \"Generate It?\"\n            })]\n          })\n        });\n      } else {\n        contents = /*#__PURE__*/_jsx(Alert, {\n          className: \"center\",\n          children: \"This map either doesn't exist, or you don't have permission to view it.\"\n        });\n      }\n\n      return /*#__PURE__*/_jsxs(\"div\", {\n        className: \"map page \".concat(loading ? 'loading' : ''),\n        children: [!data && generating && /*#__PURE__*/_jsx(\"div\", {\n          className: \"generating\",\n          children: \"Generating map...\"\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: \"title-bar\",\n          children: [/*#__PURE__*/_jsx(Editable, {\n            className: \"title \".concat(title.trim() ? '' : 'default'),\n            onChange: _this.handleTitleChange,\n            placeholder: slug,\n            readOnly: !isEditable,\n            value: title\n          }), _id && isOwner && /*#__PURE__*/_jsx(Toggle, {\n            className: \"secret\",\n            value: secret,\n            offIcon: PublicIcon,\n            onIcon: SecretIcon,\n            onToggle: _this.handleToggleSecret\n          }), _id && campaign.isEditor && /*#__PURE__*/_jsx(Toggle, {\n            className: \"in-navigation\",\n            value: _this.isNavLink,\n            offIcon: NavigationIcon,\n            offProps: {\n              title: 'Not Added to Site Navigation'\n            },\n            onIcon: NavigationIcon,\n            onProps: {\n              title: 'Added to Site Navigation'\n            },\n            onToggle: _this.handleToggleNavigation\n          }), (data || generating) && isEditable && /*#__PURE__*/_jsx(\"button\", {\n            className: \"safe\",\n            onClick: _this.handleSave,\n            disabled: saving,\n            children: \"Save\"\n          }), _id && isEditable && /*#__PURE__*/_jsx(\"button\", {\n            className: \"danger\",\n            onClick: _this.handleDelete,\n            children: \"Delete\"\n          })]\n        }), contents]\n      });\n    });\n\n    return _this;\n  }\n\n  _createClass(Map, null, [{\n    key: \"getDerivedStateFromProps\",\n    value: function getDerivedStateFromProps(props, state) {\n      if (props.slug !== state.slug) {\n        var fields = pluck(props, STATE_FIELDS);\n\n        var _ref8 = props || new URLSearchParams(window.location.search).get('title') || '',\n            title = _ref8.title;\n\n        return _objectSpread(_objectSpread({}, fields), {}, {\n          title: title\n        });\n      }\n\n      return state;\n    }\n  }]);\n\n  return Map;\n}(Component);\n\n_defineProperty(Map, \"contextType\", Application);\n\n_defineProperty(Map, \"getInitialProps\", /*#__PURE__*/function () {\n  var _ref10 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(_ref9) {\n    var query, req, headers, result, json;\n    return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            query = _ref9.query, req = _ref9.req;\n            headers = pluck(req && req.headers, 'cookie');\n            _context7.next = 4;\n            return fetch(URI(req, \"/api/map/\".concat(query.slug)), {\n              headers: headers\n            });\n\n          case 4:\n            result = _context7.sent;\n            _context7.next = 7;\n            return result.json();\n\n          case 7:\n            json = _context7.sent;\n            return _context7.abrupt(\"return\", _objectSpread({\n              httpStatusCode: result.status\n            }, json));\n\n          case 9:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7);\n  }));\n\n  return function (_x3) {\n    return _ref10.apply(this, arguments);\n  };\n}());\n\nexport { Map as default };","map":null,"metadata":{},"sourceType":"module"}